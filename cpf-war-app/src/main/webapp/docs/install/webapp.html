<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xml:lang="en"><!-- InstanceBegin template="/Templates/DocTemplate.dwt" codeOutsideHTMLIsLocked="false" -->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=8,IE=9,IE=10,IE=Edge" />
    
    <!-- InstanceBeginEditable name="doctitle" -->
<title>Web Application Installation - CPF</title>
    <script type="text/javascript">
pageId = 'webInstall';
    </script>
<!-- InstanceEndEditable -->

    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/cupertino/jquery-ui.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.datatables.net/plug-ins/9dcbecd42ad/integration/jqueryui/dataTables.jqueryui.css" rel="stylesheet" type="text/css" />
    <link href="../../css/prettify.css" rel="stylesheet" type="text/css" />
    <link href="../../css/rs.css" rel="stylesheet" type="text/css" />
    <link href="../../css/bcgov.css" rel="stylesheet" type="text/css" />
    <link href="../../css/cpf.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/plug-ins/9dcbecd42ad/integration/jqueryui/dataTables.jqueryui.js"></script>
    <script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.12.0/jquery.validate.min.js"></script>
    <script type="text/javascript" src="../../js/prettify.js"></script>
    <script type="text/javascript" src="../../js/rs.js"></script>
    <script type="text/javascript">
$(document).ready(function() {
  prettyPrint();
  setPageId(pageId);
  createToc();
});
	</script>

<!-- InstanceBeginEditable name="head" -->
<!-- InstanceEndEditable -->
  </head>
  <body>
    <div class="body">
      <div class="header">
        <div class="headerContent">
          <div class="title">
            Concurrent Processing Framework - Developer Guide
           </div>
        </div>
      </div>
      <div class="columns_2_2">
        <div class="columns_2_1">
          <div>
            <div class="column_2_1">
              <div class="sideNav">
                <div class="sideMenu">
                  <div class="title"><a href="http://www.gov.bc.ca/" title="B.C. Home">B.C. Home</a></div>
                  <ul>
                    <li><a href="../../ws/">Home</a></li>
                    <li id="overviewMenu"><a href="../../docs/">Overview</a></li>
                    <li id="clientMenu"><a href="../client/">Client Development</a><ul>
                      <li id="clientRestMenu"><a href="../client/rest-api/">Client REST API</a></li>
                      <li id="clientJavaMenu"><a href="../client/java-api/">Client Java API</a></li>
                     <!-- <li id="clientJavaMenu"><a href="../docs/client/javascript-api/">Client JavaScript API</a></li>-->
                    </ul></li>
                    <li id="pluginMenu"><a href="../plugin/">Plug-in Development</a><ul>
                      <li id="pluginOverviewMenu"><a href="../plugin/overview.html">Plug-in Overview</a></li>
                      <li id="pluginProjectMenu"><a href="../plugin/mavenProject.html">Plug-in Maven Project</a></li>
                      <li id="pluginAppMenu"><a href="../plugin/businessApplication.html">Plug-in Business Application Class</a></li>
                      <li id="pluginCustomizationMenu"><a href="../plugin/customization.html">Plug-in Customization Properties</a></li>
                      <li id="pluginConfigurationMenu"><a href="../plugin/config.html">Plug-in Configuration Properties</a></li>
                      <li id="pluginSecurityMenu"><a href="../plugin/security.html">Plug-in Security</a></li>
                      <li id="pluginTestingMenu"><a href="../plugin/testing.html">Plug-in Testing</a></li>
                      <li id="pluginJavaMenu"><a href="../plugin/java-api/" title="Plug-in Java API">Plug-in Java API</a></li>
                    </ul></li>
                    <li id="installMenu"><a href="../install/">Installation</a><ul>
                      <li id="dbInstallMenu"><a href="database.html">Database Installation</a></li>
                      <li id="webInstallMenu"><a href="webapp.html">Web Application Installation</a></li>
                    </ul></li>
                    <li id="adminMenu"><a href="../admin/">Administration</a><ul>
                      <li id="moduleMenu"><a href="../admin/module.html">Modules</a></li>
                      <li id="appMenu"><a href="../admin/app.html">Business Applications</a></li>
                      <li id="configPropertyMenu"><a href="../admin/configProperty.html">Configuration &amp; Tuning</a></li>
                      <li id="userAccountMenu"><a href="../admin/userAccount.html">User Accounts</a></li>
                      <li id="userGroupMenu"><a href="../admin/userGroup.html">User Groups</a></li>
                      <li id="userGroupPermissionMenu"><a href="../admin/userGroupPermission.html">User Group Permissions</a></li>
                      <li id="jobsMenu"><a href="../admin/job.html">Batch Jobs</a></li>
                      <li id="statisticsMenu"><a href="../admin/statistics.html">Dashboard Statistics</a></li>
                      <li id="workersMenu"><a href="../admin/worker.html">Workers</a></li>
                      <li id="logMenu"><a href="../admin/log.html">Log Files &amp; Diagnostics</a></li>
                    </ul></li>
                  </ul>
                  </div>
              </div>
            </div>
            <div class="column_2_2">
              <div class="bodyContainer">
                <div class="breadcrumbs">
                    <div class="breadcrumb">
<ul>
<li><a href="../../ws/">HOME</a></li>
<li><a href="../../docs/">Developer Guide</a></li>
<!-- InstanceBeginEditable name="crumbs" -->
        <li>Web Application Installation</li>
        <!-- InstanceEndEditable -->
</ul>
</div>
                  
                </div>
                <div class="bodyContent">
<!-- InstanceBeginEditable name="body" -->
<h1>Web Application Installation</h1>

<p>A local copy of the CPF web applications and databases should be deployed at the developer's site. For projects with multiple developers it is recommended to install a local database and J2EE servlet container on each developer's workstation and one on a central integration test server.</p>

<p>The CPF applications are deployed to a J2EE application server or servlet container. To deploy to a J2EE Servlet container the individual wars are deployed to the J2EE Servlet container.</p>

<p>Deployment is currently supported to the following J2EE Servlet containers. CPF may work with other J2EE Servlet or application contains but this has not been tested.</p>

<ul>
  <li>Tomcat 7.x</li>
</ul>

<p>For Tomcat 7.x you will need to add a user account in the manager-script role to deploy the web applications to the tomcat contained. If a user does not exist edit the <code>tomcat-users.xml</code> file in the tomcat conf directory.</p>

<figure>
<pre class="prettyprint language-xml">&lt;role rolename="manager-script"/&gt;
&lt;user username="admin" password="********" roles="manager-script"/&gt;</pre>
</figure>

<h2>Create CPF directories</h2>

<p>The CPF requires directories to be created on the server. The following directories must be created.</p>

<div class="simpleDataTable">
  <table>
  <thead>
  <tr>
    <th>Directory</th>
    <th>User Perms</th>
    <th>J2EE Server Perms</th>
    <th>Description</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td><code>/apps/cpf/config</code></td>
    <td><code>rw</code></td>
    <td><code>r</code></td>
    <td><p>The directory containing the CPF configuration file for the database URL, username and password.</p></td>
  </tr>
  <tr>
    <td><code>/apps/cpf/log</code></td>
    <td><code>r</code></td>
    <td><code>rw</code></td>
    <td><p>The directory to store the CPF logs.</p></td>
  </tr>
  <tr>
    <td><code>/apps/cpf/repository</code>
    or
    <code>/home/&lt;username&gt;/.m2/repository</code></td>
    <td><code>rw</code></td>
    <td><code>rw</code></td>
    <td><p>The local Maven repository cache. If the J2EE server is on the developers workstation use the user's local maven repository cache.</p></td>
  </tr>
  </tbody>
  </table>
</div>

<p>Create the directories using the following commands. Make sure the directory permissions are set as shown in the table above.</p>

<figure>
  <figcaption>UNIX/Mac</figcaption>
<pre class="prettyprint">mkdir -p /apps/cpf
mkdir -p /apps/cpf/config
mkdir -p /apps/cpf/log
mkdir -p /apps/cpf/repository
</pre>
</figure>

<figure>
  <figcaption>Windows</figcaption>
<pre class="prettyprint">md \apps\cpf
md \apps\cpf\config
md \apps\cpf\log
md \apps\cpf\repository
</pre>
</figure>

<h2>Create a CPF web application project</a></h2>

<p>The CPF application can be configured to connect to different types of database and be configured or extended in other ways. Therefore instead of delivering a pre-packaged war file a maven project is created for each installation that contains the configuration for that environment.</p>

<p>Create the maven project using the following maven archetype command.</p>

<figure>
  <figcaption>Unix</figcaption>
<pre class="prettyprint">cd ~/projects
mvn \
  archetype:generate \
  -DinteractiveMode=false \
  -DarchetypeGroupId=ca.bc.gov.open.cpf \
  -DarchetypeArtifactId=cpf-archetype-web \
  -DarchetypeVersion=<b>${project.version}</b> \
  -DgroupId=<b>com.mycompany</b> \
  -DartifactId=<b>cpf</b> \
  -Dversion=<b>1.0.0-SNAPSHOT</b> \
  -DmodulePrefix=<b>cpf</b> \
  -DdatabaseVendor=<b>postgresql</b> \
  -DcpfLogDirectory=<b>/apps/cpf/log</b> \
  -DcpfDirectoryUrl=<b>file:///apps/cpf</b> \
  -DmavenCacheDirectoryUrl=<b>file:///home/$USER/.m2/repository</b>
</pre>
</figure>

<p class="note">NOTE: UNIX requires commands to be entered on a single line. The \ character is a
line continuation character that treats multiple lines as a single line. Therefore you can cut and
paste the above text into a command window.</p>

<figure>
  <figcaption>Windows</figcaption>
<pre class="prettyprint">cd %HOME%\projects
mvn ^
  archetype:generate ^
  -DinteractiveMode=false ^
  -DarchetypeGroupId=ca.bc.gov.open.cpf ^
  -DarchetypeArtifactId=cpf-archetype-web ^
  -DarchetypeVersion=<b>${project.version}</b> ^
  -DgroupId=<b>com.mycompany</b> ^
  -DartifactId=<b>cpf</b> ^
  -Dversion=<b>1.0.0-SNAPSHOT</b> ^
  -DmodulePrefix=<b>cpf</b> ^
  -DdatabaseVendor=<b>postgresql</b> ^
  -DcpfLogDirectory=<b>C:/apps/cpf/log</b> ^
  -DcpfDirectoryUrl=<b>file:///apps/cpf</b> ^
  -DmavenCacheDirectoryUrl=<b>file:///%HOME:\=/%/.m2/repository</b>
</pre>
</figure>

<p class="note">NOTE: Windows requires commands to be entered on a single line. The ^ character is a
line continuation character that treats multiple lines as a single line. Therefore you can cut and
paste the above text into a command window.</p>

<div class="simpleDataTable">
  <table>
    <thead
      <tr>
      <th>Parameter</th>
      <th>Description</th>
      </tr>
    </thead>
    <tbody>
    <tr>
    <td><code>archetypeVersion</code></td>
    <td><p>The most recent version of the CPF framework.</p></td>
    </tr>
    <tr>
    <td><code>groupId</code></td>
    <td><p>The maven group identifier. This should be your company name if deploying within your development environment.</p></td>
    </tr>
    <tr>
    <td><code>artifactId</code></td>
    <td><p>The base maven artifact identifier used for the maven modules created in the project.</p></td>
    </tr>
    <tr>
    <td><code>verstion</code></td>
    <td><p>The version identifier you’d like to give to your plug-in.</p></td>
    </tr>
    <tr>
    <td><code>modulePrefix</code></td>
    <td><p>The prefix to use on the web applications.</p></td>
    </tr>
    <tr>
    <td><code>databaseVendor</code></td>
    <td><p>The database type that the CPF uses for its data. Supported values include postgresql and oracle.</p></td>
    </tr>
    <tr>
    <td><code>cpfDirectory</code></td>
    <td><p>The root directory the CPF configuration file and log files will be stored in (e.g. <code>/apps/cpf</code> or <code>C:\apps\cpf</code>).</p></td>
    </tr>
    <tr>
    <td><code>cpfDirectoryUrl</code></td>
    <td><p>The root directory the CPF configuration file and log files will be stored in (e.g. <code>/apps/cpf</code> or <code>C:\apps\cpf</code>).</p></td>
    </tr>
    <tr>
    <td><code>mavenCacheDirectoryURL</code></td>
    <td><p>The file URL to local Maven repository cache. <b>NOTE: Must start with file:/// and use web
    slashes / instead of windows slashes \</b>. If the J2EE server is on the developers workstation
    use the user's local maven repository cache. Otherwise use the repository directory below the
    <code>cpfDirectory</code> defined above (e.g. <code>file:///apps/cpf/repository</code> or
    <code>file:///C:/apps/cpf/repository</code>).</p></td>
    </tr>
    </tbody>
  </table>
</div>

<p>The following directory structure would be created if the command were run using the parameters above.</p>

<div class="simpleDataTable">
  <table>
  <thead>
    <tr>
    <th>File/Directory</th>
    <th>Description</th>
    </tr>
    </thead>
    <tr>
    <td><code>cpf</code></td>
    <td><p>The root directory of the web project.</td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;cpf.app</code></td>
    <td><p>The maven module for the web application containing the web services and scheduler.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;&nbsp;&nbsp;pom.xml</code></td>
    <td><p>The maven build file for the web services and scheduler.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;&nbsp;&nbsp;src/main/resources</code></td>
    <td><p>The resources to be included in the web application jar file.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpf-api-properties.sf.xml</code></td>
    <td><p>The configuration file for the CPF API components.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpf-web-properties.sf.xml</code></td>
    <td><p>The configuration file for the CPF web components.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log4j.xml</code></td>
    <td><p>The log4j configuration.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;&nbsp;&nbsp;src/main/webapp/META-INF/context.xml</code></td>
    <td><p>Tomcat context configuration.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;cpf.worker</code></td>
    <td><p>The maven module for the web application containing the worker.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;&nbsp;&nbsp;pom.xml</code></td>
    <td><p>The maven build file for the worker.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;&nbsp;&nbsp;src/main/resources</code></td>
    <td><p>The resources to be included in the web applications jar file.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpf-worker-properties.sf.xml</code></td>
    <td><p>The configuration file for the worker.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log4j.xml</code></td>
    <td><p>The log4j configuration.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;&nbsp;&nbsp;src/main/webapp/META-INF/context.xml</code></td>
    <td><p>Tomcat context configuration.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;pom.xml</code></td>
    <td><p>The parent maven build file that builds all modules.</p></td>
    </tr>
    <tr>
    <td><code>&nbsp;&nbsp;sample-config/cpf.properties</code></td>
    <td><p>A sample config file to copy to <code>/apps/cpf/conf/</code>.</p></td>
    </tr>
  </table>
</div>
  
<p class="note">NOTE: Developers shouldn't need to edit any of these configuration files. They are populated using the parameters specified in the maven archetype. If you need to change the cpf directory location or the database vendor it's probably easier to delete the project and create a new project using the maven archetype. All database configurations are done using runtime configuration files and plug-in configuration is stored in the database.</p>

<h2>Maven Settings Configuration</h2>

<p>A profile must be created in the <code>~/.m2/settings.xml</code> for each server environment that the CPF components are deployed to. The following example shows a full settings file with a single profile for the localhost server.</p>

<p>If you want to deploy the application to multiple servers you can create a profile for each server in your <code>~/.m2/settings.xml</code>. The profile id should be the name of the server to deploy to. For example the following shows a profile for the localhost.</p>

<figure>
<pre class="prettyprint langauage-xml">&lt;settings&gt;
  &lt;profile&gt;
    &lt;id&gt;<b>localhost</b>&lt;/id&gt;
    &lt;properties&gt;
      &lt;!-- Include the following for Tomcat 7 deployment --&gt;
      &lt;tomcat7ManagerUrl&gt;<b>http://localhost:8080/manager/text</b>&lt;/tomcat7ManagerUrl&gt;
      &lt;tomcat7ManagerUsername&gt;<b>admin</b>&lt;/tomcat7ManagerUsername&gt;
      &lt;tomcat7ManagerPassword&gt;<b>********</b>&lt;/tomcat7ManagerPassword&gt;
    &lt;/properties&gt;
  &lt;/profile&gt;
&lt;/settings&gt;
</pre>
</figure>

<h2>CPF Runtime Configuration</h2>

<p>Any configuration that changes from one server to another is included in a runtime configuration file in the <code>/apps/cpf/config</code> directory on the server. No environment specific configuration is included in the compiled WAR files, i.e. the same war could be deployed to delivery, test and production environments.</p>

<p>Copy the <code>sample-config/cpf.properties</code> file to the <code>/apps/cpf/config/cpf.properties</code> directory on the server.</p>

<div class="simpleDataTable">
  <table>
    <thead>
    <tr>
    <th>Property</th>
    <th>Description</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td><code>cpfConfig.baseUrl</code></td>
    <td><p>The base URL to the CPF apps web application (e.g. http://localhost/pub/cpf).</p></td>
    </tr>
    <tr>
    <td><code>cpfDataSource.url</code></td>
    <td><p>The full JDBC URL to the CPF database server (e.g. jdbc:postgresql:cpf).</p></td>
    </tr>
    <tr>
    <td><code>cpfDataSource.password</code></td>
    <td><p>The password for the CPF database (e.g. cpf_2009).</p></td>
    </tr>
    <tr>
    <td><code>cpfWorker.webServiceUrl</code></td>
    <td><p>The base url to the internal web services (e.g. http://localhost/pub/cpf).</p></td>
    </tr>
    <tr>
    <td><code>cpfWorker.password</code></td>
    <td><p>The password used in the internal web services (e.g. cpf_2009). Must be an http://open.gov.bc.ca/cpf/SystemUser user in the cpf.cpf_user_accounts table.</p></td>
    </tr>
    </tbody>
  </table>
</div>

<h2>External Maven Repository Configuration</h2>

<p>If the CPF is not deployed on the development server then the worker will need to be configured to point to the maven respositories that the CPF plug-ins are deployed to.</p>

<p>Edit the following configuration file. You will need to re-build and deploy if this file is modified.</p>

<pre>~/projects/cpf/cpf.app/src/main/resources/cpf-web-properties.sf.xml</pre>

<p>Add the following entries to the cpfWorkerProperties map. The first entry must be modified to the value used for the mavenCacheDirectory specified above. The second entry value must be the local file URL or remote http URL to a shared maven repository that you will deploy the plug-ins to. See <a href="http://maven.apache.org/plug-ins/maven-deploy-plug-in/">Maven Deploy Plug-in</a> for deploying to a maven repository.</p>

<figure>
<pre class="prettyprint language-xml">&lt;entry
  key="mavenRepository.root"
  value="<b>file:///apps/cpf/repository/</b>"
/&gt;

&lt;entry key="mavenRepository.repositoryLocations"&gt;
  &lt;list&gt;
    &lt;value&gt;<b>http://mycompany.com/maven/repository</b>/&lt;/value&gt;
  &lt;/list&gt;
&lt;/entry&gt;
</pre>
</figure>

<h2>Deploy to Tomcat 7</h2>

<p>The plug-in project web services &amp; scheduler war and worker war files can be deployed to a Tomcat 7 server.</p>

<p>Use the following command to compile and deploy to Tomcat.</p>

<figure>
<pre class="prettyprint">mvn -p tomcat7Deploy,<b>localhost </b>clean install</pre>
</figure>

<p>If you created multiple profiles use the profile name of the server you wish to deploy to.</p>
      
      <!-- InstanceEndEditable -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="footer">
        <div class="title">Concurrent Processing Framework (v ${project.version})</div>
        <div class="footerMenu">
          <ul>
            <li><a href="http://www2.gov.bc.ca/gov/admin/copyright.page" title="COPYRIGHT">COPYRIGHT</a></li>
            <li><a href="http://www2.gov.bc.ca/gov/admin/disclaimer.page" title="DISCLAIMER">DISCLAIMER</a></li>
            <li><a href="http://www2.gov.bc.ca/gov/admin/privacy.page" title="PRIVACY">PRIVACY</a></li>
            <li><a href="http://www2.gov.bc.ca/gov/admin/accessibility.page" title="ACCESSIBILITY">ACCESSIBILITY</a></li>
          </ul>
        </div>
      </div>
    </div>
  </body>
<!-- InstanceEnd --></html>
