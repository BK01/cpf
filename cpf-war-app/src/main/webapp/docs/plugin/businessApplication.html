<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xml:lang="en"><!-- InstanceBegin template="/Templates/DocTemplate.dwt" codeOutsideHTMLIsLocked="false" -->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=8,IE=9,IE=10,IE=Edge" />
    
    <!-- InstanceBeginEditable name="doctitle" -->
<title>Plug-in Business Application Class - CPF</title>
    <script type="text/javascript">
pageId = 'pluginApp';
    </script>
<!-- InstanceEndEditable -->

    <link
      href="https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables_themeroller.css"
      rel="stylesheet" type="text/css" />
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/cupertino/jquery-ui.css"
      rel="stylesheet" type="text/css" />
    <link href="../../css/prettify.css" rel="stylesheet" type="text/css" />
    <link href="../../css/rs.css" rel="stylesheet" type="text/css" />
    <link href="../../css/bcgov.css" rel="stylesheet" type="text/css" />
    <link href="../../css/cpf.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>
    <script type="text/javascript" src="../../js/prettify.js"></script>
    <script type="text/javascript" src="../../js/rs.js"></script>
    <script type="text/javascript">
$(document).ready(function() {
  prettyPrint();
  setPageId(pageId);
  createToc();
});
	</script>

<!-- InstanceBeginEditable name="head" -->
<!-- InstanceEndEditable -->
  </head>
  <body>
    <div class="body">
      <div class="header">
        <div class="headerContent">
          <div class="title">
            Cloud Processing Framework - Developer Guide
           </div>
        </div>
      </div>
      <div class="columns_2_2">
        <div class="columns_2_1">
          <div>
            <div class="column_2_1">
              <div class="sideNav">
                <div class="sideMenu">
                  <div class="title"><a href="http://www.gov.bc.ca/" title="B.C. Home">B.C. Home</a></div>
                  <ul>
                    <li><a href="../../ws/">Home</a></li>
                    <li id="overviewMenu"><a href="../../docs/">Overview</a></li>
                    <li id="clientMenu"><a href="../client/">Client Development</a><ul>
                      <li id="clientRestMenu"><a href="../client/rest-api/">Client REST API</a></li>
                      <li id="clientJavaMenu"><a href="../client/java-api/">Client Java API</a></li>
                     <!-- <li id="clientJavaMenu"><a href="../docs/client/javascript-api/">Client JavaScript API</a></li>-->
                    </ul></li>
                    <li id="pluginMenu"><a href="../plugin/">Plug-in Development</a><ul>
                      <li id="pluginOverviewMenu"><a href="overview.html">Plug-in Overview</a></li>
                      <li id="pluginProjectMenu"><a href="mavenProject.html">Plug-in Maven Project</a></li>
                      <li id="pluginAppMenu"><a href="businessApplication.html">Plug-in Business Application Class</a></li>
                      <li id="pluginCustomizationMenu"><a href="customization.html">Plug-in Customization Properties</a></li>
                      <li id="pluginConfigurationMenu"><a href="config.html">Plug-in Configuration Properties</a></li>
                      <li id="pluginSecurityMenu"><a href="security.html">Plug-in Security</a></li>
                      <li id="pluginTestingMenu"><a href="testing.html">Plug-in Testing</a></li>
                      <li id="pluginJavaMenu"><a href="java-api/" title="Plug-in Java API">Plug-in Java API</a></li>
                    </ul></li>
                    <li id="installMenu"><a href="../install/">Installation</a><ul>
                      <li id="dbInstallMenu"><a href="../install/database.html">Database Installation</a></li>
                      <li id="webInstallMenu"><a href="../install/webapp.html">Web Application Installation</a></li>
                    </ul></li>
                    <li id="adminMenu"><a href="../admin/">Administration</a><ul>
                      <li id="userAccountMenu"><a href="../admin/userAccount.html">User Accounts</a></li>
                      <li id="userGroupMenu"><a href="../admin/userGroup.html">User Groups</a></li>
                      <li id="userGroupPermissionMenu"><a href="../admin/userGroupPermission.html">User Group Permissions</a></li>
                    </ul></li>
                  </ul>
                  </div>
              </div>
            </div>
            <div class="column_2_2">
              <div class="bodyContainer">
                <div class="breadcrumbs">
                    <div class="breadcrumb">
<ul>
<li><a href="../../ws/">HOME</a></li>
<li><a href="../../docs/">Developer Guide</a></li>
<!-- InstanceBeginEditable name="crumbs" -->
<li><a href="../../docs/plugin">Plug-in API</a></li>
<li>Business Application Class</li>
<!-- InstanceEndEditable -->
</ul>
</div>
                  
                </div>
                <div class="bodyContent">
<!-- InstanceBeginEditable name="body" -->
<h1>Business Application Class</h1>

<h2>Java Class</h2>
<p>A business application plug-in is implemented as a Java class with the <a href="http://bcgov.revolsys.com/pub/cpf/docs/plugin/java-api/#ca.bc.gov.open.cpf.plugin.api.BusinessApplicationPlugin">BusinessApplicationPlugin</a> annotation. See <a href="http://bcgov.revolsys.com/pub/cpf/docs/plugin/java-api/#ca.bc.gov.open.cpf.plugin.api.BusinessApplicationPlugin">BusinessApplicationPlugin</a> for details of the annotation elements that can be used to configure the business application.</p>

<p>A single plug-in module can have more than one plug-in class, one for each plug-in provided by that module.</p>

<h2>Plug-in Spring Configuration File</a></h2>
<p>The CPF business application plug-in classes are registered with the CPF by including the plug-in definition spring file <code>src/main/resources/META-INF/ca.bc.gov.open.cpf.plugin.sf.xml</code> in the Maven project.</p>

<p>The following file shows an example of this file.</p>

<figure>
<pre class="prettyprint labguage-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans
  xmlns=&quot;http://www.springframework.org/schema/beans&quot;
  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xmlns:util=&quot;http://www.springframework.org/schema/util&quot;
  xmlns:p=&quot;http://www.springframework.org/schema/p&quot;
  xsi:schemaLocation=&quot;
   http://www.springframework.org/schema/beans
   http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
   http://www.springframework.org/schema/util
   http://www.springframework.org/schema/util/spring-util-3.0.xsd
  &quot;
&gt;&nbsp;
  &lt;util:list id=&quot;<b>beanImports</b>&quot;&gt;
   &lt;value&gt;<b>classpath:/ca/bc/gov/demo/Demo.sf.xml</b>&lt;/value&gt;
  &lt;/util:list&gt;

  &lt;bean
   id=&quot;<b>demo</b>&quot;
   class=&quot;<b>ca.bc.gov.demo.DemoPlug-in</b>&quot;
   p:<b>dataSource</b>-ref=&quot;<b>demoDataSource</b>&quot;
   scope=&quot;<b>prototype</b>&quot; /&gt;
&lt;/beans&gt;</pre>
</figure>

<p>This file may only contain bean definitions for the plug-ins and an optional <b>beanImports</b> list.</p>

<p>The bean definitions must have the id attribute equal to the business application plug-in name defined in the plug-in class. The class must be the fully qualified class name of the plug-in class. The scope on the bean must be set to prototype. This ensures that a new instance of the plug-in be created on each request to get the bean. The <a href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/beans.html#beans-p-namespace"><code>p:&lt;propertyName&gt;</code></a> or <a href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/beans.html#beans-p-namespace"><code>p:&lt;propertyName&gt;-ref</code></a> attribute styles can be used to inject dependencies into the bean when it is created.</p>

<p>If the plug-in requires other beans such as JDBC data sources or a caching service that are expensive to create these must be defined in plug-in resource spring configuration files. The plug-in archetype includes a blank spring file for this purpose. The <code>beanImports</code> list includes a reference to each plug-in resource spring file used by the plug-ins. This is used instead of the spring <code>import</code> mechanism so that the beans defined in those files are only instantiated on the worker nodes. Within the plug-in definition spring file no regular spring imports can be used, spring imports can however be used in the plug-in resource spring files. Additional <code>beanImports</code> can be added if required.</p>

<h2>Plug-in Resource Beans</a></h2>

<p>A new instance of the plug-in class is created for each request processed in a job. Therefore the plug-in class should not perform any complex instantiation in the constructor. Instead any resources (such as data sources) or a caching service should be defined as singleton beans in the plug-in resource spring files.</p>

<p>The plug-in bean will have a property (set/get method pair) for each resource bean it uses.</p>

<figure>
<pre class="prettyprint language-java">private DataSource dataSource;

private void setDataSource(DataSource dataSource) {
  this.dataSource = dataSource;
}

private DataSource getDataSource() {
  return dataSource;
}</pre>
</figure>

<p>The ca/bc/gov/demo/Demo.sf.xml plug-in resource spring file would define the bean as shown below.</p>

<p class="note">NOTE: this example introduces the <code>JdbcDataSourceFactoryBean</code>. This can be used to create a pooling data source without needing to know the underlying database data source used. By changing the URL to an Oracle JDBC URL it will create an Oracle data source. The config properties are set on the data source instance. Consult the database vendor's documentation for the available parameters.</p>

<figure>
<pre class="prettyprint">&lt;bean
  id=&quot;demoDataSource&quot;
  class=&quot; com.revolsys.jdbc.io.JdbcDataSourceFactoryBean&quot;
  p:url=&quot;<b>jdbc:postgresql://localhost:5432/postgres</b>&quot;
  p:username=&quot;<b>demo</b>&quot;
  p:password=&quot;<b>********</b>&quot;
&gt;
  &lt;property
   name=&quot;config&quot;
  &gt;
   &lt;map&gt;
     &lt;entry
       key=&quot;initialConnections&quot;
       value=&quot;<b>0</b>&quot; /&gt;
     &lt;entry
       key=&quot;maxConnections&quot;
       value=&quot;<b>10</b>&quot; /&gt;
    &lt;/map&gt;
  &lt;/property&gt;
&lt;/bean&gt;</pre>
</figure>

<p class="note">NOTE: Beans should not be defined with lazy-init="true". This will cause the
system to think the plug-in has been loaded when not all beans are ready. This can cause worker
threads to be blocked waiting for the beans to initialize.</p>

<p>Finally the demoDataSource bean will be injected into the <code>dataSource</code> property on the <code>demo</code> bean definition in the plug-in definition spring file.</p>

<figure>
<pre class="prettyprint">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans
  xmlns=&quot;http://www.springframework.org/schema/beans&quot;
  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xmlns:util=&quot;http://www.springframework.org/schema/util&quot;
  xmlns:p=&quot;http://www.springframework.org/schema/p&quot;
  xsi:schemaLocation=&quot;
   http://www.springframework.org/schema/beans
   http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
   http://www.springframework.org/schema/util
   http://www.springframework.org/schema/util/spring-util-3.0.xsd
  &quot;
&gt;&nbsp;
  &lt;util:list id=&quot;<b>beanImports</b>&quot;&gt;
   &lt;value&gt;<b>classpath:/com/mycompany/demo/Demo.sf.xml</b>&lt;/value&gt;
  &lt;/util:list&gt;

  &lt;bean
   id=&quot;<b>demo</b>&quot;
   class=&quot;<b>ca.bc.gov.demo.DemoPlug-in</b>&quot;
   p:<b>dataSource</b>-ref=&quot;<b>demoDataSource</b>&quot;
   scope=&quot;<b>prototype</b>&quot; /&gt;
&lt;/beans&gt;</pre>
</figure>

<p>Any required dependencies can be injected using the basic approach shown above.</p>

<h2>Plug-in Job Parameters &amp; Structured Request Parameters</a></h2>

<p>A plug-in can implement parameters that the user can specify when submitting a job. Parameters can either be global for all the requests in a job (see the <a href="java-api/#ca.bc.gov.open.cpf.plugin.api.JobParameter">JobParameter</a> anotation) or for <a href="../structuredData.html">structured input data</a> (<a href="java-api/#ca.bc.gov.open.cpf.plugin.api.BusinessApplicationPlugin.perRequestInputData">perRequestInputData</a>=false) parameters specific to an individual request within the job (see the <a href="java-api/#ca.bc.gov.open.cpf.plugin.api.RequestParameter">RequestParameter</a> anotation).</p>

<p>Parameter methods can also have the following annotations.</a>

<ul>
  <li><a href="java-api/#ca.bc.gov.open.cpf.plugin.api.AllowedValues">AllowedValues</a></li>
  <li><a href="java-api/#ca.bc.gov.open.cpf.plugin.api.DefaultValue">DefaultValue</a></li>
  <li><a href="java-api/#ca.bc.gov.open.cpf.plugin.api.GeometryConfiguration">GeometryConfiguration</a></li>
  <li><a href="java-api/#ca.bc.gov.open.cpf.plugin.api.Required">Required</a></li>
</ul>


<h2>Per request input data</a></h2>

<p><a href="../opaqueData.html">Opaque input data</a> plug-ins (<a href="java-api/#ca.bc.gov.open.cpf.plugin.api.BusinessApplicationPlugin.perRequestInputData">perRequestInputData</a>=true) must implement the following methods to set the content type of the binary blob and URL which can be used to access the binary blob of the input data for that request. The input stream for the URL can be read in the execute method of the plug-in. When getting the input stream for the URL any HTTP redirects must be followed to get the final content to read.</p>

<figure>
<pre class="prettyprint language-java">private URL inputDataUrl;

private String inputDataContentType;

public void setInputDataUrl(final URL inputDataUrl) {
  this.inputDataUrl = inputDataUrl;
}

public void setInputDataContentType (final String inputDataContentType) {
  this.inputDataContentType = inputDataContentType;
}</pre>
</figure>

<h2>Structured Result Attributes</a></h2>

<p><a href="../structuredData.html">Structured result data</a> plug-ins (<a href="java-api/#ca.bc.gov.open.cpf.plugin.api.BusinessApplicationPlugin.perRequestResultData">perRequestInputData</a>=false) must implmenent result data properties. See the <a href="java-api/#ca.bc.gov.open.cpf.plugin.api.ResultAttribute">ResultAttribute</a> anotation for more details.</p>


<p>Parameter methods can also have the following annotations.</a>

<ul>
  <li><a href="java-api/#ca.bc.gov.open.cpf.plugin.api.GeometryConfiguration">GeometryConfiguration</a></li>
</ul>

<h3>List of Structured Result Attributes</a></h3>

<p><a href="../structuredData.html">Structured result data</a> plug-ins can use the <a href="java-api/#ca.bc.gov.open.cpf.plugin.api.ResultList">ResultList</a> to return multiple results from a single request.</p>

<h2>Structured Data Geometry Request Parameters and Result Attributes</a></h2>

<p>The CPF includes spatial support for structured input data and result data files. This enables plug-ins to define job parameters, request parameters and result attributes to use <a href="http://tsusiatsoftware.net/jts/main.html">Java Topology Suite (JTS)</a> Geometry objects. The CPF reads the input data files (e.g. ESRI Shapefile in a Zip file) and converts the values into JTS Geometry objects for processing by the business application. After processing the JTS Geometry objects are converted back into the requested output spatial file format. The CPF also handles projection of the geometries if required.</p>

<p>The CPF can use <a href="http://en.wikipedia.org/wiki/Well-known_text">Well-known_text (WKT)</a> and <a href="http://postgis.org/documentation/manual-1.5/ch04.html#EWKB_EWKT">Extended WKT (EWKT)</a> geometry strings for geometries in the input data files submitted by the user or the result data files generated by the CPF. This can be used in non-spatial file formats or where there are multiple geometries in a spatial file format that only supports a single geometry. These EWKT geometries will be converted to JST Geometry objects. EWKT geometries are also used for job parameters as they are passed as HTML form parameters. We however don't recommend using geometries as job parameters.</p>

<h2>Geometry Job &amp; Request Parameters</h2>
<p>Adding a geometry job parameter or request parameter is exactly the same as any other business application parameter. The parameter type must be a JTS Geometry class or subclass. The only difference is that the <a href="java-api/#ca.bc.gov.open.cpf.plugin.api.GeometryConfiguration">GeometryConfiguration</a> annotation can also be specified. If the configuration is not set on the method then the annotation from the class is used.</p>


<h2>Geometry Result Attributes</h2>
<p>Adding a geometry result attribute is exactly the same as any other business application result attributes. The return type must be a JTS Geometry class or subclass. The only difference is that the <a href="java-api/#ca.bc.gov.open.cpf.plugin.api.GeometryConfiguration">GeometryConfiguration</a> annotation can also be specified. If the configuration is not set on the method then the annotation from the class is used.</p>

<p><b>NOTE:</b> All geometries created by a business application must have the SRID set on the geometry object.</p>

<p>The user when creating a job can override the srid, numAxis, scaleFactorXy and scaleFactorZ. The required conversion will be performed by the CPF. The business application can implement any one of the following methods to receive the values requested by the user. This might be useful if the application wants to perform it's own projection or reduce work by not creating z-values if they are not required.</p>

<figure>
<pre class="prettyprint language-java">public void setResultNumAxis(final int resultNumAxis) {
  this.resultNumAxis = resultNumAxis;
}

public void setResultScaleXy(final double resultScaleXy) {
  this.resultScaleXy = resultScaleXy;
}

public void setResultScaleZ(final double resultScaleZ) {
  this.resultScaleZ = resultScaleZ;
}

public void setResultSrid(final int resultSrid) {
   this.resultSrid = resultSrid;
  }</pre>
</figure>

<h4>Geometry Processing</h4>
<p>See <a href="java-api/#ca.bc.gov.open.cpf.plugin.api.GeometryFactory"><code>GeometryFactory</code></a> class for details on creating <a href="http://tsusiatsoftware.net/jts/main.html"/>Java Topology Suite (JTS)</a> geometry objects.</p>

<h2>Per request result data</a></h2>
<p><a href="../opaqueData.html">Opaque input data</a> plug-ins (<a href="java-api/#ca.bc.gov.open.cpf.plugin.api.BusinessApplicationPlugin.perRequestResultData">perRequestResultData</a>=true) cannot return result attributes. They can only return the binary content of the result data. The plug-in must implement the following methods. The <code>resultData</code> output stream can be used to write the result binary blob data. The <code>resultDataContentType</code> indicates to the plug-in the type of result data it should generate.</p>

<figure>
<pre class="prettyprint language-java">private OutputStream resultData;

private String resultDataContentType;

public void setResultData(final OutputStream resultData) {
  this.resultData = resultData;
}

public void setResultDataContentType(final String format) {
  this.resultDataContentType = format;
}</pre>
</figure>

<h2>Execute method</a></h2>

<p>The plug-in must implement a public void <code>execute()</code> method. When the CPF has set all the parameters on the plug-in it invokes the execute method so that the plug-in can perform the request using the parameters and generate the result.</p>

<p>The following is a simple example of an execute method that takes the value request field, calculates the square and stores this in the square result attribute.</p>

<figure>
<pre class="prettyprint language-java">public void execute() {
  this.square = this.value * this.value;
}</pre>
</figure>

<p>The following is an example of a per request input data execute method. The plug-in gets the input stream from the inputDataUrl, performs some processing on the data and stores the result in the digest result attribute.</p>

<figure>
<pre class="prettyprint language-java">public void execute() {
  try {
    MessageDigest digester = MessageDigest.getInstance(&quot;MD5&quot;);
    InputStream in = this.inputDataUrl.openStream();
    byte[] buffer = new byte[4096];
    for (int count = in.read(buffer); count != -1; count = in.read(buffer)) {
       digester.update(buffer, 0, count);
     }
    byte[] data = digester.digest();
    this.digest = new String(Hex.encodeHex(data));
  } catch (NoSuchAlgorithmException e) {
    throw new IllegalArgumentException(&quot;Cannot find digest algorithm &quot; + algorithmName, e);
  } catch (IOException e) {
    throw new RuntimeException(&quot;Cannot read input data&quot;, e);
  }
}</pre>
</figure>

<p>The following is an example of a per request result data execute method. The plug-in creates query string parameters from the plug-in request parameters and creates a connection to a web service. The plug-in then writes the response from the web service to the result data.</p>

<figure>
<pre class="prettyprint">public void execute() {
  Map&lt;String, Object&gt; parameters = new LinkedHashMap&lt;String, Object&gt;();
  parameters.put(&quot;SERVICE&quot;, &quot;WMS&quot;);
  parameters.put(&quot;VERSION&quot;, &quot;1.1.1&quot;);
  parameters.put(&quot;REQUEST&quot;, &quot;GetMap&quot;);
  parameters.put(&quot;LAYERS&quot;, <b>this.layers</b>);
  parameters.put(&quot;STYLES&quot;, <b>this.styles</b>);
  parameters.put(&quot;CRS&quot;, <b>this.crs</b>);
  parameters.put(&quot;BBOX&quot;, <b>this.bbox</b>);
  parameters.put(&quot;WIDTH&quot;, <b>this.width</b>);
  parameters.put(&quot;HEIGHT&quot;, <b>this.height</b>);
  parameters.put(&quot;FORMAT&quot;, <b>this.resultDataContentType</b>);
  parameters.put(&quot;EXCEPTIONS&quot;, &quot;INIMAGE&quot;);
  String url = UrlUtil.getUrl(<b>this.wmsUrl</b>, parameters);
  try {
    InputStream in = new URL(url).openStream();
    try {
      FileUtil.copy(in, <b>this.resultData</b>);
    } finally {
      FileUtil.closeSilent(<b>this.resultData</b>);
      FileUtil.closeSilent(in);
    }
  } catch (MalformedURLException e) {
    throw new IllegalArgumentException(url + &quot; is not valid URL&quot;);
  } catch (IOException e) {
    throw new RuntimeException(&quot;Unable to get map&quot;, e);
  }
}</pre>
</figure>


<h2>Logging</h2>

<p>Due to the distributed nature of the CPF regular logging frameworks such as log4j should not be used as the logs will be on each worker and not available from the CPF admin web application. See the <a href="java-api/#ca.bc.gov.open.cpf.plugin.api.log.AppLog">AppLog</a> class for details
of the logging API business application plug-ins should use.</p>

<h2>Memory Management</h2>

<p>Plug-ins must ensure that their data and classes can be garbage collected when the plug-in is
stopped. Below are some guidelines for ensuring garbage collection.</p>

<ul>
  <li>Avoid using the Java singleton pattern for cached data structures. The data won't be released
  unil the class is garbage collected (which maybe neve depending on the JVM). Use
  a spring bean with the default singleton scope instead.</p>
  <li>Avoid aspect oriented libraries, especially that use CGLIB. These sometimes create classes that
  can't get garbage collected.</li>
  <li>If using Java introspection/reflection, ensure that class and method references are not stored in a cache owned by another JVM.
  CPF has code to perform cache clearing for commons beanutils.</li>
  <li>Implement a cleanup method on each bean (other than the
  plug-in prototype bean). This method should close any resources it created (e.g. database
  connections), clear any cached values and preferably set any fields to null. See the spring framework
  documentation for details in implementing 
  <a href="http://docs.spring.io/spring/docs/3.0.7.RELEASE/reference/beans.html#beans-factory-lifecycle-disposablebean">Destruction callbacks</a>
  or <a href="http://docs.spring.io/spring/docs/3.0.7.RELEASE/reference/beans.html#beans-postconstruct-and-predestroy-annotations">@PreDestory annotation</a>.
  Spring will automatically call those methods when the plug-in is stopped.</li>
</ul>

<p>The CPF Tomcat JVM should be started with the following parameters to allow class unloading. Consult your JVM's documentation for more details.</p>
<figure>
<pre>-XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled -XX:+UseCodeCacheFlushing</pre>
</figure>

<p>In a non-production environment you can also turn on the following option to see the classes that
were garbage collected on the console output from the Tomcat command.</p>

<figure>
<pre>-XX:+TraceClassUnloading</pre>
</figure>

<p>The following proceedure can be used to see if a CPF module can be un-loaded successfully.</p>

<ol>
  <li>Restart the Tomcat JVM to ensure a clean start.</li>
  <li>Make sure the CPF module is started (don't restart if already started).</li>
  <li>Stop the CPF module using the CPF admin application. Or to test CPF too undeploy the CPF web apps using the Tomcat manager.</li>
  <li>Use the jconsole tool that comes with the JDK (not JRE) to connect to the Tomcat Java process.</li>
  <li>Click on the memory tab.</li>
  <li>Click on 'Perform GC' about 5 times to force a garbage collection.</li>
  <li>Click on the Classes tab and see if the Loaded count is lower than the Total Loaded. This
  shows that some classes were garbage collected. You may need to do 'Perform GC' or wait a while
  as there is no contract as to when the class garbage collection will occur.</p>
  <li>The following command creates a memory dump of the JVM you will need to know the process id [PID] of the Tomcat JVM. <code>jmap -dump:live,format=b,file=cpf.hprof [PID]</code>.</li>
  <li>The cpf.hprof can be loaded into a Java Heap analyzer or the following command can be used to create a web server where you can browse the memory.<ol>
    <li><code>jhat -J-mx1024m cpf.hprof</code> (NOTE: you may need more memory depending on the amount of memory used in the Tomcat JVM.</li>
    <li>Open <a href="http://localhost:7000/">http://localhost:7000/</a> in a web browser. 
    The <a href="http://localhost:7000/showInstanceCounts/">http://localhost:7000/showInstanceCounts/</a>
    page is the most useful as it shows the counts of objects by class for non core Java class.</li>
    <li>Check that the custom classes used by your application do no appear on this page. If they do then the application has not been garbage collected.</li>
    <li>Click the instances link next to a class to see the instances. From there you can naviagte to see the references to that object. This will help identify where cleanup code should be implemented.</li>
  </ol></li>
</ol>
 
<div class="pageNavigation">
  <table>
    <tr>
      <td class="previous"><a href="mavenProject.html">&lt; Previous - Create Maven Project</a></td>
      <td class="home"><a href="./">Home</a></td>
      <td class="next"><a href="customization.html">Customization Properties - Next &gt;</a></td>
    </tr>
  </table>
</div>


<!-- InstanceEndEditable -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="footer">
        <div class="title">Cloud Processing Framework (v ${project.version})</div>
        <div class="footerMenu">
          <ul>
            <li><a href="http://www2.gov.bc.ca/gov/admin/copyright.page" title="COPYRIGHT">COPYRIGHT</a></li>
            <li><a href="http://www2.gov.bc.ca/gov/admin/disclaimer.page" title="DISCLAIMER">DISCLAIMER</a></li>
            <li><a href="http://www2.gov.bc.ca/gov/admin/privacy.page" title="PRIVACY">PRIVACY</a></li>
            <li><a href="http://www2.gov.bc.ca/gov/admin/accessibility.page" title="ACCESSIBILITY">ACCESSIBILITY</a></li>
          </ul>
        </div>
      </div>
    </div>
  </body>
<!-- InstanceEnd --></html>
