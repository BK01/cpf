<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xml:lang="en"><!-- InstanceBegin template="/Templates/DocTemplate.dwt" codeOutsideHTMLIsLocked="false" -->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=8,IE=9,IE=10,IE=Edge" />
    
    <!-- InstanceBeginEditable name="doctitle" -->
<title>CPF Plug-in Security</title>
pageId = 'pluginClass';
<!-- InstanceEndEditable -->

    <link
      href="https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables_themeroller.css"
      rel="stylesheet" type="text/css" />
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/cupertino/jquery-ui.css"
      rel="stylesheet" type="text/css" />
    <link href="../../css/prettify.css" rel="stylesheet" type="text/css" />
    <link href="../../css/rs.css" rel="stylesheet" type="text/css" />
    <link href="../../css/bcgov.css" rel="stylesheet" type="text/css" />
    <link href="../../css/cpf.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>
    <script type="text/javascript" src="../../js/prettify.js"></script>
    <script type="text/javascript" src="../../js/rs.js"></script>
    <script type="text/javascript">
$(document).ready(function() {
  prettyPrint();
  setPageId(pageId);
  createToc();
});
	</script>

<!-- InstanceBeginEditable name="head" -->
<!-- InstanceEndEditable -->
  </head>
  <body>
    <div class="body">
      <div class="header">
        <div class="headerContent">
          <div class="title">
            Cloud Processing Framework - Developer Guide
           </div>
        </div>
      </div>
      <div class="columns_2_2">
        <div class="columns_2_1">
          <div>
            <div class="column_2_1">
              <div class="sideNav">
                <div class="sideMenu">
                  <div class="title"><a href="http://www.gov.bc.ca/" title="B.C. Home">B.C. Home</a></div>
                  <ul>
                    <li><a href="../../ws/">Home</a></li>
                    <li id="overviewMenu"><a href="../../docs/">Overview</a></li>
                    <li id="clientMenu"><a href="../client/">Client Development</a><ul>
                      <li id="clientRestMenu"><a href="../client/rest-api/">Client REST API</a></li>
                      <li id="clientJavaMenu"><a href="../client/java-api/">Client Java API</a></li>
                     <!-- <li id="clientJavaMenu"><a href="../docs/client/javascript-api/">Client JavaScript API</a></li>-->
                    </ul></li>
                    <li id="pluginMenu"><a href="../plugin/">Plug-in Development</a><ul>
                      <li id="pluginOverviewMenu"><a href="overview.html">Plug-in Overview</a></li>
                      <li id="pluginProjectMenu"><a href="mavenProject.html">Plug-in Maven Project</a></li>
                      <li id="pluginAppMenu"><a href="businessApplication.html">Plug-in Business Application Class</a></li>
                      <li id="pluginCustomizationMenu"><a href="customization.html">Plug-in Customization Properties</a></li>
                      <li id="pluginConfigurationMenu"><a href="config.html">Plug-in Configuration Properties</a></li>
                      <li id="pluginSecurityMenu"><a href="security.html">Plug-in Security</a></li>
                      <li id="pluginTestingMenu"><a href="testing.html">Plug-in Testing</a></li>
                      <li id="pluginJavaMenu"><a href="java-api/" title="Plug-in Java API">Plug-in Java API</a></li>
                    </ul></li>
                    <li id="installMenu"><a href="../install/">Installation</a><ul>
                      <li id="dbInstallMenu"><a href="../install/database.html">Database Installation</a></li>
                      <li id="webInstallMenu"><a href="../install/webapp.html">Web Application Installation</a></li>
                    </ul></li>
                    <li id="adminMenu"><a href="../admin/">Administration</a><ul>
                      <li id="configPropertyMenu"><a href="../admin/configProperty.html">Config Properties</a></li>
                      <li id="userAccountMenu"><a href="../admin/userAccount.html">User Accounts</a></li>
                      <li id="userGroupMenu"><a href="../admin/userGroup.html">User Groups</a></li>
                      <li id="userGroupPermissionMenu"><a href="../admin/userGroupPermission.html">User Group Permissions</a></li>
                    </ul></li>
                  </ul>
                  </div>
              </div>
            </div>
            <div class="column_2_2">
              <div class="bodyContainer">
                <div class="breadcrumbs">
                    <div class="breadcrumb">
<ul>
<li><a href="../../ws/">HOME</a></li>
<li><a href="../../docs/">Developer Guide</a></li>
<!-- InstanceBeginEditable name="crumbs" -->
<li><a href="../../docs/plugin">Plug-in API</a></li>
<li>Security</li>
<!-- InstanceEndEditable -->
</ul>
</div>
                  
                </div>
                <div class="bodyContent">
<!-- InstanceBeginEditable name="body" -->
<h1>CPF Plug-in Class</h1>

<h2>Write Plug-in Class</h2>
<p>A business application plug-in is implemented as a Java class. The class is annotated<a href="#_ftn2" name="_ftnref2" title=""> </a> with CPF specific annotations on the plug-in’s classes and methods. A single plug-in project can have more than one plug-in class, one for each plug-in provided by that module.</p>

<p>An instance of the plug-in class is created for each request processed by the plug-in. Therefore it must not include the initialization of any resources that have significant overhead to create. These should be defined as spring beans and made available to the plug-in using spring dependency injection. If there are data structures that vary based on the parameters to a request then these can be created within the plug-in.</p>

<h3>Plug-in Spring Configuration File</a></h3>
<p>The CPF business application plug-in classes can be registered with the CPF by including the <b>plug-in definition spring</b> file META-INF/ca.bc.gov.open.cpf.plugin.sf.xml in the jar file for the plug-in.</p>

<p>The following file shows an example of this file.</p>

<figure>
<pre class="prettyprint">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans
  xmlns=&quot;http://www.springframework.org/schema/beans&quot;
  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xmlns:util=&quot;http://www.springframework.org/schema/util&quot;
  xmlns:p=&quot;http://www.springframework.org/schema/p&quot;
  xsi:schemaLocation=&quot;
   http://www.springframework.org/schema/beans
   http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
   http://www.springframework.org/schema/util
   http://www.springframework.org/schema/util/spring-util-3.0.xsd
  &quot;
&gt;&nbsp;
  &lt;util:list id=&quot;<b>beanImports</b>&quot;&gt;
   &lt;value&gt;<b>classpath:/ca/bc/gov/demo/Demo.sf.xml</b>&lt;/value&gt;
  &lt;/util:list&gt;

  &lt;bean
   id=&quot;<b>demo</b>&quot;
   class=&quot;<b>ca.bc.gov.demo.DemoPlug-in</b>&quot;
   p:<b>dataSource</b>-ref=&quot;<b>demoDataSource</b>&quot;
   scope=&quot;<b>prototype</b>&quot; /&gt;
&lt;/beans&gt;</pre>
</figure>

<p>This file may only contain bean definitions for the plug-ins and an optional <b>beanImports</b> list.</p>

<p>The bean definitions must have the id attribute equal to the business application plug-in name defined in the plug-in class. The class must be the fully qualified class name of the plug-in class. The scope on the bean must be set to prototype. This ensures that a new instance of the plug-in be created on each request to get the bean. The p:&lt;propertyName&gt; <a href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/beans.html#beans-p-namespace">http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/beans.html#beans-p-namespace</a> or p:&lt;propertyName&gt;-ref attribute styles can be used to inject dependencies into the bean when it is created.</p>

<p>If the plug-in requires other beans such as JDBC data sources or a caching service that are expensive to create these must be defined in <b>plug-in resource spring</b> configuration files. The plug-in archetype includes a blank spring file for this purpose. The <b>beanImports</b> list includes a reference to each <b>plug-in resource spring</b> file used by the plug-ins. This is used instead of the spring <b>import</b> mechanism so that the beans defined in those files are only instantiated on the worker nodes. Within the <b>plug-in definition spring</b> file no regular spring imports can be used, spring imports can however be used in the <b>plug-in resource spring</b> files. Additional <b>beanImports</b> can be added if required.</p>

<h3>Class annotations</a></h3>


<p>The instance of the plug-in is executed within a single thread so does not need to be synchronized. Any services that it uses must however be thread safe as they will be used by multiple instances of the plug-in in different threads.</p>

<h3>Plug-in Resource Beans</a></h3>
<p>A new instance of the plug-in class is created for each request processed in a job. Therefore the plug-in class should not perform any complex instantiation in the constructor. Instead any resources (such as data sources) or a caching service should be defined as singleton beans in the <b>plug-in resource spring</b> files.</p>

<p>The plug-in bean would then have a property (set/get method pair) for each resource bean it uses.</p>

<figure>
<pre class="prettyprint">private DataSource dataSource;

private void setDataSource(DataSource dataSource) {
  this.dataSource = dataSource;
}

private DataSource getDataSource() {
  return dataSource;
}</pre>
</figure>
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
<b>LOGGING</b>
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

<p>The com/mycompany/demo/Demo.sf.xml <b>plug-in resource spring</b> file would define the bean as shown below. Note that this example introduces the JdbcDataSourceFactoryBean. This can be used to create a pooling data source without needing to know the underlying database data source used. By changing the URL to an Oracle JDBC URL it will create an Oracle data source. The config properties are set on the data source instance. Consult the database vendor's documentation for the available parameters.</p>

<figure>
<pre class="prettyprint">&lt;bean
  id=&quot;demoDataSource&quot;
  class=&quot; com.revolsys.jdbc.io.JdbcDataSourceFactoryBean&quot;
  p:url=&quot;<b>jdbc:postgresql://localhost:5432/postgres</b>&quot;
  p:username=&quot;<b>demo</b>&quot;
  p:password=&quot;<b>********</b>&quot;
&gt;
  &lt;property
   name=&quot;config&quot;
  &gt;
   &lt;map&gt;
     &lt;entry
       key=&quot;initialConnections&quot;
       value=&quot;<b>0</b>&quot; /&gt;
     &lt;entry
       key=&quot;maxConnections&quot;
       value=&quot;<b>10</b>&quot; /&gt;
    &lt;/map&gt;
  &lt;/property&gt;
&lt;/bean&gt;</pre>
</figure>

<p>To use the data source factory you'll need to include one of the following dependencies in your plug-in. Note that the version uses a property obtained from the cpf-parent module that is the parent of all plug-ins created by the archetype. Therefore this value will never need to change.</p>


<figure>
<figcaption>PostgreSQL</figcaption>
<pre class="prettyprint">&lt;dependency&gt;
  &lt;groupId&gt;com.revolsys.open&lt;/groupId&gt;
  &lt;artifactId&gt;com.revolsys.open.gis.<b>postgresql</b>&lt;/artifactId&gt;
  &lt;version&gt;${com.revolsys.open.version}&lt;/version&gt;
&lt;/dependency&gt;</pre>
</figure>

<figure>
<figcaption>Oracle</figcaption>
<pre class="prettyprint"> &lt;dependency&gt;
  &lt;groupId&gt;com.revolsys.open&lt;/groupId&gt;
  &lt;artifactId&gt;com.revolsys.open.gis.<b>oracle</b>&lt;/artifactId&gt;
  &lt;version&gt;${com.revolsys.open.version}&lt;/version&gt;
&lt;/dependency&gt;</pre>
</figure>

<p>Finally the demoDataSource bean will be injected into the dataSource property on the demo bean definition in the <b>plug-in definition spring</b> file.</p>

<figure>
<pre class="prettyprint">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans
  xmlns=&quot;http://www.springframework.org/schema/beans&quot;
  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xmlns:util=&quot;http://www.springframework.org/schema/util&quot;
  xmlns:p=&quot;http://www.springframework.org/schema/p&quot;
  xsi:schemaLocation=&quot;
   http://www.springframework.org/schema/beans
   http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
   http://www.springframework.org/schema/util
   http://www.springframework.org/schema/util/spring-util-3.0.xsd
  &quot;
&gt;&nbsp;
  &lt;util:list id=&quot;<b>beanImports</b>&quot;&gt;
   &lt;value&gt;<b>classpath:/com/mycompany/demo/Demo.sf.xml</b>&lt;/value&gt;
  &lt;/util:list&gt;

  &lt;bean
   id=&quot;<b>demo</b>&quot;
   class=&quot;<b>ca.bc.gov.demo.DemoPlug-in</b>&quot;
   p:<b>dataSource</b>-ref=&quot;<b>demoDataSource</b>&quot;
   scope=&quot;<b>prototype</b>&quot; /&gt;
&lt;/beans&gt;</pre>
</figure>

<p>Any required dependencies can be injected using the basic approach shown above.</p>

<h3>Plug-in Job Parameters &amp; Structured Request Parameters</a></h3>
<p>A plug-in can implement parameters that the user can specify when submitting a job. Parameters can either be global for all the requests in a job or specific to an individual request within the job.</p>

<p>Parameters are implemented as Java bean properties on the class. The plug-in will implement a set property method for each parameter. The parameter name is the name of the Java bean property. Job and Request Parameters can only use the following data types byte, short, int, long, float, double, boolean, String, URL. Request parameters can also use JTS Point, LineString, Polygon, MultiPoint, MultiLineString and MultiPolygon.</p>

<p>Parameters for the whole job use the ca.bc.gov.open.cpf.plugin.api.JobParameter annotation and parameters for each request use the ca.bc.gov.open.cpf.plugin.api.RequestParameter annotation. Both annotations can be specified on a single set property method to indicate that the parameter can be specified either on the job or on a request. The ca.bc.gov.open.cpf.plugin.api.Required annotation is used to mark the parameter as being required. If a value is not specified for a required parameter the scheduler will exclude that request from being processed and an error returned. </p>

<p>Both job and request parameter annotations also support the description, index, length and scale attributes. The description is used as Input help text on the form. The index defines the order of the parameters on the HTML form. The length is the size of the field (number of characters or digits). The scale is the number of decimal places.
   
  The ca.bc.gov.open.cpf.plugin.api.DefaultValue annotation can be used to specify the default value to be displayed on the CPF job submission form or to be set on the plugin if the user did not specify the value. The value must be specified as a string. The CPF will attempt to convert this string to the data type of the parameter.</p>

<p>The ca.bc.gov.open.cpf.plugin.api.AllowedValues annotation can be used to specify the list of allowed values that can be used for the parameter. The field on the job submission form will be displayed as a select list containing these values.</p>

<figure>
<pre class="prettyprint">private int value;
 @RequestParameter(
  index=2,
   description=&quot;The value to calculate the square for (1-4)&quot;
)
@JobParameter
@DefaultValue(&quot;2&quot;)
@AllowedValues(value = {&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;})
@Required
public void setValue(int value) {
  this.value = value;
}</pre>
</figure>

<p>The ca.bc.gov.open.cpf.plugin.api.RequestParameter annotation cannot be used for plug-ins which accept per request input data perRequestInputData=true. </p>

<p>See the following class for an example.</p>

<p><a href="http://apps.bcgov/wsvn/CITZ.cpf/api-source/trunk/cpf-plug-ins-samples/src/main/java/ca/bc/gov/open/cpf/plug-in/samples/WebMapImage.java">http://apps.bcgov/wsvn/CITZ.cpf/api-source/trunk/cpf-plug-ins-samples/src/main/java/ca/bc/gov/open/cpf/plug-in/samples/WebMapImage.java</a></p>

<h3>Per request input data</a></h3>
<p>Plug-ins that accept per request input data perRequestInputData=true must implement the following methods to set the content type of the binary blob and URL which can be used to access the binary blob of the input data for that request. The input stream for the URL can be read in the execute method of the plug-in. When getting the input stream for the URL any HTTP redirects must be followed to get the final content to read.</p>

<figure>
<pre class="prettyprint">private URL inputDataUrl;

private String inputDataContentType;

public void setInputDataUrl(final URL inputDataUrl) {
  this.inputDataUrl = inputDataUrl;
}

public void setInputDataContentType (final String inputDataContentType) {
  this.inputDataContentType = inputDataContentType;
}</pre>
</figure>

<p>See the following class for an example.</p>

<p><a href="https://apps.gov.bc.ca/int/wsvn/CITZ.cpf/api-source/trunk/cpf-plugins-samples/src/main/java/ca/bc/gov/open/cpf/plugin/samples/Digest.java">http://apps.bcgov/wsvn/CITZ.cpf/api-source/trunk/cpf-plug-ins-samples/src/main/java/ca/bc/gov/open/cpf/plug-in/samples/Digest.java</a></p>

<h3>Structured Result Attributes</a></h3>
<p>Plug-ins that do not accept per request result data perRequestResultData=false can return structured result attributes. Result attributes are implemented as Java bean properties on the class. The plug-in will implement a get or is property method for each result attribute. The result attribute name is the name of the Java bean property. Parameters can only use the following data types byte, short, int, long, float, double, boolean, String, URL, JTS Point, LineString, Polygon, MultiPoint, MultiLineString and MultiPolygon.. The result attributes will be converted by the CPF to the correct representation in the output format or a string representation of the value before being returned to the user.</p>

<p>The ca.bc.gov.open.cpf.plugin.api.ResultAttribute annotation marks a get or is property method as being a result attribute. Result attribute annotations also support the description, index, length and scale attributes. The description is used as Input help text on the business application description page. If the description is omitted and there was a job or request parameter of the same name then the description will be taken from the parameter. The index defines the order of the attributes in the result file. The length is the size of the field (number of characters or digits). The scale is the number of decimal places.</p>

<figure>
<pre class="prettyprint">private int square;
      
@ResultAttribute(
  index=2,
  description=&quot;The square of a value&quot;
)
public int getSquare() {
  return square;
}</pre>
</figure>

<p>See the following class for an example.</p>

<p><a href="http://apps.bcgov/wsvn/CITZ.cpf/api-source/trunk/cpf-plug-ins-samples/src/main/java/ca/bc/gov/open/cpf/plug-in/samples/UserInfo.java">http://apps.bcgov/wsvn/CITZ.cpf/api-source/trunk/cpf-plug-ins-samples/src/main/java/ca/bc/gov/open/cpf/plug-in/samples/UserInfo.java</a></p>

<h3>List of Structured Result Attributes</a></h3>
<p>Plug-ins that do not accept per request result data perRequestResultData=false can return a list of structured result attributes if the plug-in returns multiple results instead of a single result.</p>

<p>To return a list of results the plug-in must implement a get method that returns a list of a specified value object (e.g. ResultObject). The method must also have the annotation ca.bc.gov.open.cpf.plugin.api.ResultList. The plug-in class must not have any methods marked with the ResultAttribute annotation.</p>

<figure>
<pre class="prettyprint">private List&lt;ResultObject&gt; 

@ResultList
public List&lt;ResultObject&gt; getResults() {
  return results;
}</pre>
</figure>

<p>The value object class contains the result attributes to return for each result in the list. Pick an appropriate name for the value object (e.g. Address). The value object class must have one or more get methods with the ca.bc.gov.open.cpf.plugin.api.ResultAttribute annotation. These are the attributes that are returned to the client. The same rules apply as per structured result attributes.</p>

<figure>
<pre class="prettyprint">public class ResultObject
private String attribute1;
  
@ResultAttribute
public int getAttribute1 () {
  return attribute1;
}</pre>
</figure>

<h3>Structured Data Geometry Request Parameters and Result Attributes</a></h3>
<p>The CPF includes spatial support for structured input data and result data files. This enables plug-ins to define job parameters, request parameters and result attributes to use Java Topology Suite (JTS)<a href="#_ftn3" name="_ftnref3" title=""> </a> Geometry objects. The CPF reads the input data files (e.g. ESRI Shapefile in a Zip file) and converts the values into JTS Geometry objects for processing by the business application. After processing the JTS Geometry objects are converted back into the requested output spatial file format. The CPF also handles projection of the geometries if required.</p>

<p>The CPF can use Extended Well-Known Text<a href="#_ftn4" name="_ftnref4" title=""> </a> (EWKT) geometry strings for geometries in the input data files submitted by the user or the result data files generated by the CPF. This can be used in non-spatial file formats or where there are multiple geometries in a spatial file format that only supports a single geometry. These EWKT geometries will be converted to JST Geometry objects. EWKT geometries are also used for job parameters as they are passed as HTML form parameters. We however don't recommend using geometries as job parameters.</p>

<h4>Geometry Job &amp; Request Parameters</h4>
<p>Adding a geometry job parameter or request parameter is exactly the same as any other business application parameter. The parameter type must be a JTS Geometry class or subclass. The only difference is that the GeometryConfiguration attribute above can also be specified. If the configuration is not set on the method then the annotation from the class is used.</p>

<p>The following example shows a geometry parameter with a geometry configuration. The plug-in expects the geometry in BC Albers (3005). If the user submits a WGS84 (4326) geometry it will be projected to BC Albers before being passed to the plug-in. The number of axis is 3 so the geometry will always have x, y, z values with Double.NaN if the source geometry was 2D. The scaleFactorXy is 1000, which indicates a 1mm precision (1/1000 = 0.001), the source geometry will be rounded to this precision. The scaleFactorZ is 1, which indicates a 1m precision, the source geometry will be rounded to this precision. As validate is true the geometry will be checked using the OGC is valid predicate. If the validation fails the plug-in will not be executed. Finally the geometry is marked as being the primary geometry.</p>

<figure>
<pre class="prettyprint">@RequestParameter
@GeometryConfiguration(
  srid = <b>3005</b>,
  numAxis = <b>3</b>,
  scaleFactorXy = <b>1000</b>,
  scaleFactorZ = <b>1</b>,
  validate = <b>true</b>,
  primaryGeometry = <b>true</b>)
public void setGeometry(final Geometry geometry) {
  this.geometry = geometry;
}</pre>
</figure>



<h4>Geometry Result Attributes</h4>
<p>Adding a geometry result attribute is exactly the same as any other business application result attributes. The return type must be a JTS Geometry<a href="#_ftn5" name="_ftnref5" title=""> </a> class or subclass. The only difference is that the GeometryConfiguration attribute above can also be specified. If the configuration is not set on the method then the annotation from the class is used.</p>

<p>The following example shows a geometry result attribute with a geometry configuration. The plug-in indicates that the user will get the geometry in BC Albers (3005). If the plug-in returns a WGS84 (4326) geometry it will be projected to BC Albers before being returned to the use. The number of axis is s so the geometry will only have x, y, if the plug-in returned a 3D geometry the z-value will be removed. The scaleFactorXy is 1000, which indicates a 1mm precision (1/1000 = 0.001). The geometry will be rounded to this precision. The scaleFactorZ is 1, which indicates a 1m precision. The geometry will be rounded to this precision. As validate is true the geometry will be checked using the OGC is valid predicate. If the validation fails the plug-in will not be executed. Finally the geometry is marked as being the primary geometry.</p>

<p><b>NOTE:</b> All geometries created by a business application must have the SRID set on the geometry object.</p>

<p>The user when creating a job can override the srid, numAxis, scaleFactorXy and scaleFactorZ. The required conversion will be performed by the CPF. The business application can implement any one of the following methods to receive the values requested by the user. This might be useful if the application wants to perform it's own projection or reduce work by not creating z-values if they are not required.</p>

<figure>
<pre class="prettyprint">public void setResultNumAxis(final int resultNumAxis) {
  this.resultNumAxis = resultNumAxis;
}

public void setResultScaleXy(final double resultScaleXy) {
  this.resultScaleXy = resultScaleXy;
}

public void setResultScaleZ(final double resultScaleZ) {
  this.resultScaleZ = resultScaleZ;
}

public void setResultSrid(final int resultSrid) {
   this.resultSrid = resultSrid;
  }</pre>
</figure>

<h4>Geometry Processing</h4>
<p>See <a href="java-api/#ca.bc.gov.open.cpf.plugin.api.GeometryFactory"><code>GeometryFactory</code></a> class for details on creating <a href=http://tsusiatsoftware.net/jts/main.html"/>Java Topology Suite (JTS)</a> geometry objects.</p>

<h3>Per request result data</a></h3>
<p>Plug-ins that accept per request input data perRequestResultData=true cannot return result attributes. They can only return the binary content of the result data. The plug-in must implement the following methods. The resultData output stream can be used to write the result binary blob data. The resultDataContentType indicates to the plug-in the type of result data it should generate.</p>

<figure>
<pre class="prettyprint">private OutputStream resultData;

private String resultDataContentType;

public void setResultData(final OutputStream resultData) {
  this.resultData = resultData;
}

public void setResultDataContentType(final String format) {
  this.resultDataContentType = format;
}</pre>
</figure>

<p>See the following class for an example.</p>

<p><a href="http://apps.bcgov/wsvn/CITZ.cpf/api-source/trunk/cpf-plug-ins-samples/src/main/java/ca/bc/gov/open/cpf/plug-in/samples/WebMapImage.java">http://apps.bcgov/wsvn/CITZ.cpf/api-source/trunk/cpf-plug-ins-samples/src/main/java/ca/bc/gov/open/cpf/plug-in/samples/WebMapImage.java</a></p>

<h3>Execute method</a></h3>
<p>The plug-in must implement a public void execute() method. When the CPF has set all the parameters on the plug-in it invokes the execute method so that the plug-in can perform the request using the parameters and generate the result.</p>

<p>The following is a simple example of an execute method that takes the value request field, calculates the square and stores this in the square result attribute.</p>

<figure>
<pre class="prettyprint">public void execute() {
  this.square = this.value * this.value;
}</pre>
</figure>

<p>The following is an example of a per request input data execute method. The plug-in gets the input stream from the inputDataUrl, performs some processing on the data and stores the result in the digest result attribute.</p>

<figure>
<pre class="prettyprint">try {
  MessageDigest digester = MessageDigest.getInstance(&quot;MD5&quot;);
  InputStream in = this.inputDataUrl.openStream();
  byte[] buffer = new byte[4096];
  for (int count = in.read(buffer); count != -1; count = in.read(buffer)) {
     digester.update(buffer, 0, count);
   }
  byte[] data = digester.digest();
  this.digest = new String(Hex.encodeHex(data));
} catch (NoSuchAlgorithmException e) {
  throw new IllegalArgumentException(&quot;Cannot find digest algorithm &quot; + algorithmName, e);
} catch (IOException e) {
  throw new RuntimeException(&quot;Cannot read input data&quot;, e);
}</pre>
</figure>

<p>The following is an example of a per request result data execute method. The plug-in creates query string parameters from the plug-in request parameters and creates a connection to a web service. The plug-in then writes the response from the web service to the result data.</p>

<figure>
<pre class="prettyprint">public void execute() {
  Map&lt;String, Object&gt; parameters = new LinkedHashMap&lt;String, Object&gt;();
  parameters.put(&quot;SERVICE&quot;, &quot;WMS&quot;);
  parameters.put(&quot;VERSION&quot;, &quot;1.1.1&quot;);
  parameters.put(&quot;REQUEST&quot;, &quot;GetMap&quot;);
  parameters.put(&quot;LAYERS&quot;, <b>this.layers</b>);
  parameters.put(&quot;STYLES&quot;, <b>this.styles</b>);
  parameters.put(&quot;CRS&quot;, <b>this.crs</b>);
  parameters.put(&quot;BBOX&quot;, <b>this.bbox</b>);
  parameters.put(&quot;WIDTH&quot;, <b>this.width</b>);
  parameters.put(&quot;HEIGHT&quot;, <b>this.height</b>);
  parameters.put(&quot;FORMAT&quot;, <b>this.resultDataContentType</b>);
  parameters.put(&quot;EXCEPTIONS&quot;, &quot;INIMAGE&quot;);
  String url = UrlUtil.getUrl(<b>this.wmsUrl</b>, parameters);
  try {
    InputStream in = new URL(url).openStream();
    try {
      FileUtil.copy(in, <b>this.resultData</b>);
    } finally {
      FileUtil.closeSilent(<b>this.resultData</b>);
      FileUtil.closeSilent(in);
    }
  } catch (MalformedURLException e) {
    throw new IllegalArgumentException(url + &quot; is not valid URL&quot;);
  } catch (IOException e) {
    throw new RuntimeException(&quot;Unable to get map&quot;, e);
  }
}</pre>
</figure>


<a href="http://maven.apache.org/guides/introduction/introduction-to-optional-and-excludes-dependencies.html#Dependency_Exclusions">Dependency Exclusions</a>

<a href="http://en.wikipedia.org/wiki/Java_annotation">Java annotation</a>

<a href="http://tsusiatsoftware.net/jts/main.html">Java Topology Suite</a>


<p>The Well-Known text WKT encoding is described at <a href="http://en.wikipedia.org/wiki/Well-known_text">Well-known_text</a>. The SRID can also be specified using the PostGIS EWKT SIRD=&lt;srid&gt;; prefix, see <a href="http://postgis.org/documentation/manual-1.5/ch04.html#EWKB_EWKT">Extended EKT</a>.</p>

<p>Plug-ins can use the Geometry and GeometryCollection classes as a return type. However some file formats (ESRI Shapefile) can only support a single specific type of geometry (e.g. Point, LineString, Polygon). Therefore if the plug-in is only going to return a Point geometry, use the Point class as the return type.</p>



<!-- InstanceEndEditable -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="footer">
        <div class="title">Cloud Processing Framework (v ${project.version})</div>
        <div class="footerMenu">
          <ul>
            <li><a href="http://www2.gov.bc.ca/gov/admin/copyright.page" title="COPYRIGHT">COPYRIGHT</a></li>
            <li><a href="http://www2.gov.bc.ca/gov/admin/disclaimer.page" title="DISCLAIMER">DISCLAIMER</a></li>
            <li><a href="http://www2.gov.bc.ca/gov/admin/privacy.page" title="PRIVACY">PRIVACY</a></li>
            <li><a href="http://www2.gov.bc.ca/gov/admin/accessibility.page" title="ACCESSIBILITY">ACCESSIBILITY</a></li>
          </ul>
        </div>
      </div>
    </div>
  </body>
<!-- InstanceEnd --></html>
